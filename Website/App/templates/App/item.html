{% extends 'App/template_blocks/base.html' %}
{% load static %}
{% load tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'App/item.css' %}">

<section id="layer1" class="layers">

    <section id="main-item-container">
        {% include 'App/template_blocks/item_container.html' %}
    </section>

    <section id="info-overview">
        <div class="info-block">
            <h3>Prices & Quantity</h3>
            
            <div id="metric-change-container">
                <div class="tool-tip">
                    <span class="tool-tip-icon">?</span>
                    <p class="tool-tip-text">% change since oldest record</p>
                </div>
                <p id="metric-change"> {{metric}} Change (%) {{ item.price_change|postivie_or_negative_sign }} </p>
            </div>
            <p>Total Quantity Available {{item.total_quantity}}</p>
            <p>Avg Price {{item.avg_price}}</p>
            <p>Min Price {{item.min_price}}</p>
            <p>Max Price {{item.max_price}}</p>

        </div>

        <div class="info-block">
            <h3>Sets and Pieces</h3>
            <p>Pieces : {{sub_sets|length}}</p>
            <p>Sets : {{super_sets|length}}</p>
        </div>

        <div class="info-block">
            <h3>General Info</h3>
            <p>Owned By : {{total_owners}}</p>
            <p>Watched By : {{total_watchers}}</p>

            <div id="item-themes-container">
                <h4>Themes</h4>
                {% for theme in item_themes %}
                    <p>{{theme.0|count_theme_indent}}</p>
                {% endfor %}
            </div>  
        </div>
    </section>

</section>

<section id="layer2" class="layers">

    <div id="chart-form-container">
        <form action="{% url 'item' item.item_id %}" method="POST">
            {% csrf_token %}
            <label for="graph-data-form">Graph Data</label>
            <select onchange="this.form.submit()" name="graph-metric">
                {% for graph_option in graph_options %}
                    <option value="{{graph_option.value}}">{{graph_option.text}}</option>
                {% endfor %}
            </select>
        </form>
    </div>
    <section id="chart-container">
        <div id="chart-background">
            {% include 'App/template_blocks/item_chart.html' %}
        </div>
        <div id="chart-options">
            <p style="display: none;" id="slider-index">{{item.dates|length}}</p>
            <div id="slider-output-container">
                <p id="slider-output">Range : {{item.dates.0}} - {% with item.dates|last as last %}{{last}}{% endwith %}</p>
            </div>

            <div id="slider-container">
                <input id="slider" type="range" name="slider" min="2" max="{{item.dates|length}}" value="{{item.dates|length}}">
            </div>
        </div>
    </section>

    <section id="in-collections-forms-container">

        <section id="in-collections">
            {% if in_portfolio|length != 0%}
                <p>In Portfolio | {% for condition in in_portfolio %} {{condition.condition}} : {{condition.count}} | {% endfor %}</p>
            {% else %}
                <p>In Portfolio : No</p>
            {% endif %}
            <p>In Watchlist : {{in_watchlist}}</p>
        </section>

        <section id="form-container">
            <h3>Add to Your Collection</h3>
            <form action="{% url 'add_to_user_items' item.item_id %}" method="post">
                {% csrf_token %}
                <div id="add-to-portfolio">
                    <div class="label-input-container">
                        <label for="condition">Condition</label>
                        <select name="condition">
                            <option value="N">New</option>
                            <option value="U">Used</option>
                        </select>
                    </div>

                    <div class="label-input-container">
                        <label for="quantity">Quantity</label>
                        <input min="1" value="1" type="number" name="quantity">
                    </div>

                    <button name="view-type" type="submit" value="portfolio">Add to Portfolio!</button>
            
                </div>
                <div id="add-to-watchlist">
                    <button name="view-type" type="submit" value="watchlist">Add to Watchlist!</button>
                </div>

                <p id="error-msg">{{ add_to_user_items_error_msg }}</p>
            </form>
        </section>

    </section>

</section>

<section id="layer3" class="layers">
    <section id="super-sets-container">
        {% for set in super_sets %}
            <div class="set-container">
                <p>{{set.set_id}}</p>
                <p>{{set.set_name}}</p>
            </div>
        {% endfor %}
    </section>

    <section id="super-sets-container">
        {% for piece in sub_sets %}
            {{piece}}
        {% endfor %}
    </section>
</section>

{% if similar_items|length > 0 %}

<section id="layer4" class="layers">
    <section id="similar-items">
        <h3 id="similar-items-heading">Similar Items</h3>
        <div id="similar-items-container">
            {% for item in similar_items %}
            <div class="similar-item-container">
                {% include 'App/template_blocks/item_container.html' with item=item %} 
            </div>
            {% endfor %}
        </div>
    </section>
</section>

{% endif %}

{% with item.dates as dates  %}
    {{ item.dates|json_script:"dates" }}
{% endwith %}

{% with item.prices as prices  %}
    {{ item.prices|json_script:"prices" }}
{% endwith %}
<script>
    var slider = document.getElementById("slider");
    var output = document.getElementById("slider-output");
    var index = document.getElementById("slider-index")

    slider.oninput = function() {
        var dates = JSON.parse(document.getElementById('dates').textContent);
        var prices = JSON.parse(document.getElementById('prices').textContent);

        dates = dates.slice(0, slider.value)
        prices = prices.slice(0, slider.value)

        output.innerHTML = `Range : ${dates[0]} - ${dates[parseInt(slider.value)-1]}`
        index.innerHTML = slider.value -1

        var data = [];
        for (let i = 0; i < prices.length; i++) {
            data.push({y:prices[i], x:dates[i]});
        }

        mychart.data.datasets[0].data = data
        mychart.data.labels = dates
        mychart.update()
  
    }
</script>

{% endblock %}
